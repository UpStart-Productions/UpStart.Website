version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # --- Go (needed for Hugo Modules) ---
            - export GO_VERSION=${GO_VERSION:-1.22.6}
            - curl -sSL -o /tmp/go.tgz "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz"
            - rm -rf /usr/local/go && tar -C /usr/local -xzf /tmp/go.tgz
            - ln -sf /usr/local/go/bin/* /usr/local/bin/
            - go version

            # --- Hugo EXTENDED v0.149.0 ---
            - export HUGO_VERSION=${HUGO_VERSION:-0.149.0}
            - curl -sSL -o /tmp/hugo.tar.gz "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz"
            - tar -xzf /tmp/hugo.tar.gz -C /usr/local/bin hugo
            - hugo version

            # --- Hugo Modules ---
            - export GOPATH=$HOME/go
            - export PATH=$GOPATH/bin:/usr/local/go/bin:$PATH
            - export HUGO_ENV=production
            - hugo mod tidy
            - hugo mod vendor         # cache modules locally for faster builds

            # --- Optional theme postcss step if your theme has package-lock.json ---
            - if [ -f package-lock.json ]; then npm ci; fi
        build:
          commands:
            - echo "Building Hugo site..."
            - hugo --minify
      artifacts:
        baseDirectory: public
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - $HOME/go/pkg/mod/**/*
          - resources/_gen/**/*
          - _vendor/**/*
