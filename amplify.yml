version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            # Install Hugo (extended) in a writable path
            - export HUGO_VERSION=${HUGO_VERSION:-0.149.0}
            - curl -sSL -o /tmp/hugo.tar.gz "https://github.com/gohugoio/hugo/releases/download/v${HUGO_VERSION}/hugo_extended_${HUGO_VERSION}_Linux-64bit.tar.gz"
            - mkdir -p "$HOME/bin"
            - tar -xzf /tmp/hugo.tar.gz -C "$HOME/bin" hugo
            - chmod +x "$HOME/bin/hugo"
            - export PATH="$HOME/bin:$PATH"
            - hugo version

            # Optional: install PostCSS deps if your repo has a package-lock.json
            - if [ -f package-lock.json ]; then npm ci; fi

            # Ensure Blowfish theme is present WITHOUT Go or rsync
            - set -e
            - VENDOR_PATH="_vendor/github.com/nunocoracao/blowfish/v2"
            - mkdir -p themes
            - |
              if [ -d "$VENDOR_PATH" ]; then
                echo "Using vendored Blowfish from $VENDOR_PATH"
                mkdir -p themes/blowfish
                (cd "$VENDOR_PATH" && tar cf - .) | (cd themes/blowfish && tar xpf -)
              else
                echo "Vendored Blowfish not found; cloning theme"
                git clone --depth 1 --branch v2 https://github.com/nunocoracao/blowfish themes/blowfish \
                  || git clone --depth 1 https://github.com/nunocoracao/blowfish themes/blowfish
              fi
        build:
          commands:
            - echo "Building Hugo site..."
            # Force the theme to avoid any module/theme ambiguity during CI:
            - hugo --minify --theme blowfish
      artifacts:
        baseDirectory: public
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - resources/_gen/**/*
          - _vendor/**/*
          - themes/blowfish/**/*
